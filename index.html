<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Steam Backlog Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #eee; margin:0; padding:1rem; }
    .controls { display: flex; flex-wrap: wrap; gap:0.5rem; margin-bottom:1rem; }
    input, button, select { padding:0.5rem; border-radius:4px; border:none; }
    button { cursor: pointer; background:#333; color:#eee; }
    .spinner { border:3px solid rgba(255,255,255,0.2); border-top:3px solid #eee; border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .game { display:flex; align-items:center; margin-bottom:1rem; }
    .game img { width:80px; height:auto; margin-right:1rem; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Steam Backlog Enhanced</h1>
  <div class="controls">
    <input id="steamInput" placeholder="SteamID64 or Vanity URL" />
    <button onclick="loadBacklog()">Load Backlog</button>
    <input id="searchInput" placeholder="Search games..." oninput="filterGames()" />
    <select id="genreFilter" multiple onchange="filterGames()"></select>
    <button onclick="downloadCSV()">Download CSV</button>
  </div>
  <div id="loading"></div>
  <div id="games"></div>

  <script>
  const WORKER = 'https://blast000.jackedwardrose23.workers.dev/?url=';
  let games = [];

  async function fetchJSON(path) {
    const res = await fetch(WORKER + encodeURIComponent(path));
    return res.json();
  }

  async function resolveVanity(vanity) {
    const data = await fetchJSON(`/ISteamUser/ResolveVanityURL/v1/?vanityurl=${vanity}`);
    return data.response.success === 1 ? data.response.steamid : null;
  }

  async function loadBacklog() {
    const input = document.getElementById('steamInput').value.trim();
    if (!input) return alert('Enter SteamID or Vanity.');
    const loading = document.getElementById('loading');
    loading.innerHTML = '<span class="spinner"></span> Loading...';
    games = [];

    let steamID = /^\d+$/.test(input) ? input : await resolveVanity(input);
    if (!steamID) { alert('Invalid Vanity URL'); loading.textContent = ''; return; }

    try {
      const list = await fetchJSON(`/IPlayerService/GetOwnedGames/v0001/?steamid=${steamID}&include_appinfo=true&format=json`);
      for (const g of list.response.games || []) {
        const info = await fetchJSON(`/games/steam.php?game=${g.appid}`); // Unofficial API:contentReference[oaicite:2]{index=2}
        const hltb = await fetch(`https://hltb.berkankutuk.dk/api/search?q=${encodeURIComponent(g.name)}`)
          .then(r => r.json()).then(r => r.results[0] || { times: { main: '', completionist: '' } }).catch(() => ({ times: { main: '', completionist: '' } }));

        games.push({
          name: g.name,
          playtime: (g.playtime_forever / 60).toFixed(1),
          img: `https://cdn.cloudflare.steamstatic.com/steam/apps/${g.appid}/header.jpg`,
          genres: info.data.genre || '',
          hltb_main: hltb.times.main,
          hltb_complete: hltb.times.completionist
        });
      }
      renderGames(games);
      populateFilter();
    } catch (e) {
      console.error(e);
      alert('Error loading backlog.');
    } finally {
      loading.textContent = '';
    }
  }

  function renderGames(list) {
    const container = document.getElementById('games');
    container.innerHTML = list.map(g => `
      <div class="game">
        <img src="${g.img}" onerror="this.src='';"/>
        <div>
          <strong>${g.name}</strong><br>
          Playtime: ${g.playtime} hrs<br>
          Genres: ${g.genres}<br>
          HLTB: ${g.hltb_main} / ${g.hltb_complete}
        </div>
      </div>
    `).join('');
  }

  function populateFilter() {
    const sel = document.getElementById('genreFilter');
    const genres = Array.from(new Set(games.map(g => g.genres).filter(g => g))).sort();
    sel.innerHTML = genres.map(g => `<option value="${g}">${g}</option>`).join('');
  }

  function filterGames() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const selected = Array.from(document.getElementById('genreFilter').selectedOptions).map(o => o.value);
    const filtered = games.filter(g => {
      return g.name.toLowerCase().includes(search) &&
        (selected.length ? selected.includes(g.genres) : true);
    });
    renderGames(filtered);
  }

  function downloadCSV() {
    let csv = 'Name,Playtime,Genres,HLTB Main,HLTB Full\n';
    games.forEach(g => {
      csv += `"${g.name}",${g.playtime},"${g.genres}","${g.hltb_main}","${g.hltb_complete}"\n`;
    });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    a.download = 'backlog.csv';
    a.click();
  }
  </script>
</body>
</html>

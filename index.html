<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Steam Backlog Viewer</title>
  <style>
    body {
      background-color: #121212;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 2em;
    }
    input, button, select {
      padding: 0.5em;
      margin: 0.3em 0.5em 0.3em 0;
      background: #1e1e1e;
      border: 1px solid #444;
      color: #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2em;
    }
    th, td {
      border: 1px solid #444;
      padding: 0.5em;
      text-align: left;
    }
    th {
      background-color: #222;
    }
    #darkToggle {
      float: right;
    }
    #spinner {
      display: none;
      margin-top: 20px;
      font-weight: bold;
    }
    .game-image {
      width: 120px;
      height: 45px;
      background-color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .game-image img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    .image-spinner {
      position: absolute;
      color: white;
      font-size: 0.8em;
    }
  </style>
</head>
<body>

  <h1>Steam Backlog Viewer</h1>

  <input type="text" id="steamInput" placeholder="Steam ID or vanity name" />
  <button onclick="start()">Load Backlog</button>
  <input type="text" id="searchInput" placeholder="Search games..." oninput="filterGames()" />
  <select id="filterSelect" onchange="filterGames()">
    <option value="all">All</option>
    <option value="unplayed">Unplayed Only</option>
  </select>
  <button onclick="downloadCSV()">Download CSV</button>
  <button id="darkToggle" onclick="toggleDarkMode()">Toggle Dark Mode</button>

  <div id="spinner">üîÑ Loading...</div>

  <table id="gamesTable" style="display:none;">
    <thead>
      <tr>
        <th>Cover</th>
        <th>Game</th>
        <th>Playtime (hrs)</th>
        <th>Genre</th>
        <th>HowLongToBeat (Main)</th>
        <th>Completionist</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiKey = 'FE4B00EA4F8A36A9B4A9636BEBC325DD';
    let allGames = [];

    function toggleDarkMode() {
      document.body.classList.toggle('light');
      document.body.style.backgroundColor = document.body.classList.contains('light') ? '#f5f5f5' : '#121212';
      document.body.style.color = document.body.classList.contains('light') ? '#000' : '#eee';
    }

    async function resolveVanity(username) {
      const url = `https://api.steampowered.com/ISteamUser/ResolveVanityURL/v1/?key=${apiKey}&vanityurl=${username}`;
      const corsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(corsUrl);
      const data = await res.json();
      if (data.response.success === 1) {
        return data.response.steamid;
      } else {
        throw new Error("Could not resolve vanity username");
      }
    }

    async function loadBacklog(steamID) {
      const spinner = document.getElementById('spinner');
      spinner.style.display = 'block';
      const url = `https://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${apiKey}&steamid=${steamID}&include_appinfo=true&format=json`;
      const corsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

      try {
        const res = await fetch(corsUrl);
        const data = await res.json();
        const games = data.response.games;
        allGames = await Promise.all(games.map(augmentGameData));
        displayGames(allGames);
      } catch (err) {
        console.error("Failed to fetch games:", err);
        alert("Could not load games. Make sure your Steam profile is public.");
      } finally {
        spinner.style.display = 'none';
      }
    }

    async function augmentGameData(game) {
      const fakeGenres = ['Action', 'RPG', 'Puzzle', 'Shooter', 'Indie', 'Adventure'];
      return {
        appid: game.appid,
        name: game.name,
        playtime: (game.playtime_forever / 60).toFixed(1),
        genre: fakeGenres[Math.floor(Math.random() * fakeGenres.length)],
        hltb_main: (Math.random() * 20 + 1).toFixed(1) + 'h',
        hltb_completionist: (Math.random() * 40 + 5).toFixed(1) + 'h'
      };
    }

    function displayGames(games) {
      const table = document.getElementById('gamesTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';

      games.forEach(game => {
        const row = document.createElement('tr');

        const imgCell = document.createElement('td');
        const wrapper = document.createElement('div');
        wrapper.className = 'game-image';

        const spinner = document.createElement('div');
        spinner.className = 'image-spinner';
        spinner.textContent = 'Loading...';

        const img = document.createElement('img');
        img.src = `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/capsule_231x87.jpg`;
        img.onload = () => spinner.style.display = 'none';
        img.onerror = () => {
          spinner.textContent = '‚ùå';
          img.style.display = 'none';
        };

        wrapper.appendChild(img);
        wrapper.appendChild(spinner);
        imgCell.appendChild(wrapper);

        row.appendChild(imgCell);
        row.innerHTML += `
          <td>${game.name}</td>
          <td>${game.playtime}</td>
          <td>${game.genre}</td>
          <td>${game.hltb_main}</td>
          <td>${game.hltb_completionist}</td>
        `;
        tbody.appendChild(row);
      });

      table.style.display = 'table';
    }

    function filterGames() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filter = document.getElementById('filterSelect').value;

      const filtered = allGames.filter(game => {
        const matchesSearch = game.name.toLowerCase().includes(searchTerm);
        const matchesFilter = filter === 'unplayed' ? parseFloat(game.playtime) === 0 : true;
        return matchesSearch && matchesFilter;
      });

      displayGames(filtered);
    }

    async function start() {
      const input = document.getElementById('steamInput').value.trim();
      if (!input) return alert("Please enter your Steam ID or username.");
      let steamID = input;

      if (isNaN(input)) {
        try {
          steamID = await resolveVanity(input);
        } catch (err) {
          return alert("Invalid vanity username.");
        }
      }

      document.getElementById('gamesTable').style.display = 'none';
      document.querySelector('#gamesTable tbody').innerHTML = '';
      loadBacklog(steamID);
    }

    function downloadCSV() {
      if (allGames.length === 0) {
        alert("No games loaded.");
        return;
      }

      const rows = [
        ["Name", "Playtime (hrs)", "Genre", "HLTB Main", "HLTB Completionist"],
        ...allGames.map(g => [g.name, g.playtime, g.genre, g.hltb_main, g.hltb_completionist])
      ];

      const csv = rows.map(r => r.map(field => `"${field}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = "steam_backlog.csv";
      a.click();

      URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>
